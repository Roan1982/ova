{% extends 'core/base.html' %}
{% block title %}Estado del Sistema de IA{% endblock %}

{% block extra_styles %}
<style>
:root {
  --success: #22c55e; --warning: #f59e0b; --danger: #dc2626; --info: #3b82f6;
  --bg-card: #1f2937; --text-primary: #f9fafb; --text-secondary: #d1d5db;
}
.status-card { background: var(--bg-card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid var(--info); }
.status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
.status-available { background: var(--success); box-shadow: 0 0 8px rgba(34, 197, 94, 0.4); }
.status-unavailable { background: var(--danger); box-shadow: 0 0 8px rgba(220, 38, 38, 0.4); }
.config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
.config-item { background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2); }
.test-section { background: linear-gradient(135deg, #065f46, #047857); padding: 20px; border-radius: 12px; margin-top: 20px; }
.test-result { background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; margin-top: 15px; font-family: 'Courier New', monospace; }
.json-display { background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #334155; white-space: pre-wrap; font-family: 'Courier New', monospace; color: #e2e8f0; }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
  <h1>ü§ñ Estado del Sistema de IA</h1>

  <!-- Estado General -->
  <div class="status-card">
    <h2>üìä Estado Actual</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
      <div>
        <h4>üîó Proveedor en la Nube</h4>
        <span class="status-indicator {% if status.cloud_available %}status-available{% else %}status-unavailable{% endif %}"></span>
        <span>
          {% if status.cloud_available %}
            {{ status.provider|upper }} operativo
          {% else %}
            {{ status.provider|upper }} no disponible
          {% endif %}
        </span>
      </div>
      <div>
        <h4>üß† IA Local (Respaldo)</h4>
        <span class="status-indicator {% if status.local_ai_available %}status-available{% else %}status-unavailable{% endif %}"></span>
        <span>{% if status.local_ai_available %}Operativa{% else %}Error{% endif %}</span>
      </div>
      <div>
        <h4>‚ö° Sistema Activo</h4>
        <span style="color: var(--info); font-weight: bold;">{{ status.current_system|upper }}</span>
        <br><small style="color: var(--text-secondary);">
          {% if status.current_system != 'local' %}
            Usando {{ status.current_system|upper }} como proveedor principal
          {% else %}
            Operando con IA local basada en reglas (respaldo)
          {% endif %}
        </small>
      </div>
    </div>
    {% if status.details.last_error %}
      <div style="margin-top: 15px; padding: 12px; background: rgba(220, 38, 38, 0.15); border-radius: 8px; border-left: 3px solid var(--danger); color: var(--text-secondary);">
        <strong>√öltimo error reportado:</strong><br>
        <small>{{ status.details.last_error }}</small>
      </div>
    {% endif %}
  </div>

  <!-- Configuraci√≥n -->
  <div class="status-card">
    <h2>‚öôÔ∏è Configuraci√≥n</h2>
    <div class="config-grid">
      <div class="config-item">
        <strong>Proveedor configurado:</strong><br>
        <code>{{ settings_config.AI_PROVIDER|upper }}</code>
      </div>
      <div class="config-item">
        <strong>Modelo en uso:</strong><br>
        <code>{{ settings_config.OPENAI_MODEL }}</code>
      </div>
      <div class="config-item">
        <strong>Endpoint API:</strong><br>
        <code>{{ settings_config.OPENAI_API_BASE }}</code>
      </div>
      <div class="config-item">
        <strong>API Key cargada:</strong><br>
        <code>{% if settings_config.OPENAI_API_KEY_CONFIGURADO %}‚úÖ S√≠{% else %}‚ö†Ô∏è No{% endif %}</code>
      </div>
    </div>
  </div>

  <!-- Test en Vivo -->
  <div class="test-section">
    <h2 style="color: white; margin-top: 0;">üß™ Test de Clasificaci√≥n</h2>
    <p style="color: #d1fae5;">
      <strong>Descripci√≥n de prueba:</strong><br>
      "{{ test_description }}"
    </p>
    
    <div class="test-result">
      {% if test_result %}
        <div style="color: var(--success); margin-bottom: 10px;">
          ‚úÖ <strong>Clasificaci√≥n exitosa</strong>
          {% if test_result.fuente %}
            <span style="color: var(--info);">(Sistema: {{ test_result.fuente|upper }})</span>
          {% endif %}
        </div>
        <div class="json-display">{{ test_result|pprint }}</div>
        
        {% if test_result.respuesta_ia %}
          <div style="margin-top: 15px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; border-left: 3px solid var(--success);">
            <strong style="color: var(--success);">Respuesta de IA:</strong><br>
            <span style="color: var(--text-primary);">{{ test_result.respuesta_ia }}</span>
          </div>
        {% endif %}
      {% elif test_error %}
        <div style="color: var(--danger);">
          ‚ùå <strong>Error en la clasificaci√≥n:</strong><br>
          {{ test_error }}
        </div>
      {% else %}
        <div style="color: var(--warning);">
          ‚ö†Ô∏è <strong>Sin respuesta del sistema de IA</strong>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Informaci√≥n Adicional -->
  <div class="status-card">
    <h2>üìã Informaci√≥n del Sistema</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
      <div>
        <h4>üéØ Capacidades de Clasificaci√≥n</h4>
        <ul style="color: var(--text-secondary); margin: 0; padding-left: 20px;">
          <li>Tipos: Policial, M√©dico, Bomberos</li>
          <li>C√≥digos: Rojo (cr√≠tico), Amarillo (urgente), Verde (leve)</li>
          <li>An√°lisis de gravedad con puntaje</li>
          <li>Generaci√≥n de respuestas inteligentes</li>
          <li>Detecci√≥n de patrones espec√≠ficos</li>
        </ul>
      </div>
      <div>
        <h4>üîÑ Funcionamiento</h4>
        <ul style="color: var(--text-secondary); margin: 0; padding-left: 20px;">
          <li>Intento primario: {{ status.provider|upper }}</li>
          <li>Respaldo autom√°tico: IA local basada en reglas</li>
          <li>Tolerancia a fallos garantizada</li>
          <li>Clasificaci√≥n en tiempo real</li>
          <li>Actualizaci√≥n autom√°tica de prioridades</li>
        </ul>
      </div>
    </div>
  </div>

  <div style="text-align: center; margin-top: 30px;">
    <a href="{% url 'dashboard' %}" class="btn" style="margin-right: 10px;">üè† Volver al Dashboard</a>
    <button onclick="location.reload()" class="btn" style="background: var(--success);">üîÑ Actualizar Estado</button>
  </div>
</div>
{% endblock %}
