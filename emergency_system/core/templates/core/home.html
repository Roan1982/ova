{% extends 'core/base.html' %}
{% block title %}Centro de Control CABA{% endblock %}
{% block extra_head %}<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>{% endblock %}
{% block extra_styles %}
#map { height: 600px; border-radius: 12px; border: 2px solid #1f2937; }
.hero { display: grid; grid-template-columns: 1.4fr .6fr; gap: 16px; align-items: start; }
.legend { display:flex; gap:15px; align-items:center; flex-wrap:wrap; font-size: 12px; color: var(--muted); margin-top: 12px; }
.legend-item { display: flex; align-items: center; gap: 6px; background: #0f172a; padding: 4px 8px; border-radius: 4px; }
.dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
.dot.rojo { background: #dc2626; }
.dot.amarillo { background: #f59e0b; }
.dot.verde { background: #22c55e; }
.dot.agente-policia { background: #3b82f6; }
.dot.agente-bomberos { background: #dc2626; }
.dot.agente-same { background: #10b981; }
.dot.agente-transito { background: #f59e0b; }
.dot.instalacion { background: #8b5cf6; }
.map-controls { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
.map-btn { padding: 6px 10px; font-size: 11px; border: 1px solid #374151; background: #111827; color: #d1d5db; border-radius: 4px; cursor: pointer; }
.map-btn:hover { background: #1f2937; }
.map-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

/* Ticker de actividades */
.activity-ticker { background: linear-gradient(135deg, #1e293b, #334155); border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.ticker-header { background: rgba(59,130,246,0.1); padding: 12px 16px; font-size: 14px; font-weight: 700; color: #60a5fa; border-bottom: 1px solid rgba(59,130,246,0.2); }
.ticker-content { display: flex; animation: scroll 25s linear infinite; padding: 12px 0; }
.ticker-item { color: #e2e8f0; font-size: 15px; white-space: nowrap; padding: 0 32px; border-right: 1px solid rgba(255,255,255,0.1); font-weight: 500; }
@keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
.stats-mini { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
.stat-mini { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); padding: 10px; border-radius: 8px; text-align: center; font-size: 12px; }
.stat-mini .value { font-size: 18px; font-weight: bold; color: #60a5fa; display: block; margin-bottom: 4px; }
.emergency-ticker { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 8px; padding: 12px; margin-top: 15px; }
.ticker-title { font-size: 12px; color: #10b981; margin-bottom: 8px; font-weight: 600; }
.ticker-item { font-size: 10px; padding: 4px 0; border-bottom: 1px solid #1f2937; }
.ticker-item:last-child { border-bottom: none; }

/* Estilos para el sistema de rutas */
.emergency-pulse {
  animation: emergency-pulse 2s ease-in-out infinite;
}

.emergency-selected {
  animation: emergency-selected 1s ease-in-out infinite;
  filter: drop-shadow(0 0 10px #60a5fa);
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.notification-toast {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.route-popup {
  min-width: 250px;
}

.route-popup .btn {
  margin: 2px;
}

@keyframes emergency-pulse {
  0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
  100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
}

@keyframes emergency-selected {
  0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.8); }
  50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.3); }
  100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}

/* Rutas en el mapa */
.route-line {
  stroke-width: 4;
  stroke-dasharray: 10,10;
  animation: route-dash 2s linear infinite;
}

.tracking-line {
  stroke-width: 6;
  stroke-dasharray: 5,15;
  animation: tracking-dash 1.5s linear infinite;
}

@keyframes route-dash {
  to { stroke-dashoffset: -20; }
}

@keyframes tracking-dash {
  to { stroke-dashoffset: -20; }
}

/* Botones de ruta en popups */
.route-btn {
  display: inline-block;
  padding: 4px 8px;
  margin: 2px;
  border: none;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
}

.route-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Sem√°foros y onda verde */
.traffic-light-green {
  animation: traffic-pulse 2s ease-in-out infinite;
}

.traffic-light-red {
  animation: traffic-red-pulse 1s ease-in-out infinite;
}

@keyframes traffic-pulse {
  0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.8); }
  70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
  100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
}

@keyframes traffic-red-pulse {
  0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.8); }
  50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0.3); }
  100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
}

@media (max-width: 1200px) { 
  .hero { grid-template-columns: 1fr !important; } 
  .card { margin-bottom: 20px; }
}
</style>
{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px; height: calc(100vh - 120px);">
  <!-- Mapa principal -->
  <div class="card" style="overflow: hidden;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h2 style="margin: 0;">üó∫Ô∏è Mapa Operativo CABA</h2>
      <!-- Controles del mapa compactos -->
      <div style="display: flex; gap: 6px; flex-wrap: wrap;">
        <button class="map-btn active" data-layer="emergencias" style="font-size: 11px; padding: 4px 8px;">üö®</button>
        <button class="map-btn active" data-layer="agentes" style="font-size: 11px; padding: 4px 8px;">üëÆ</button>
        <button class="map-btn active" data-layer="instalaciones" style="font-size: 11px; padding: 4px 8px;">üè¢</button>
        <button class="map-btn active" data-layer="hospitales" style="font-size: 11px; padding: 4px 8px;">üè•</button>
        <button class="map-btn active" data-layer="rutas" style="font-size: 11px; padding: 4px 8px;">üõ£Ô∏è</button>
        <button class="map-btn" data-layer="comunas" style="font-size: 11px; padding: 4px 8px;">üìç</button>
        <button class="map-btn" id="btn-centrar" style="font-size: 11px; padding: 4px 8px;">üéØ</button>
        <button class="map-btn" id="btn-limpiar-rutas" style="font-size: 11px; padding: 4px 8px;">üßπ</button>
        <button class="map-btn" id="btn-redistribuir" style="font-size: 11px; padding: 4px 8px;">üîÑ</button>
        <button class="map-btn" id="btn-test-routes" style="font-size: 11px; padding: 4px 8px;">üîç</button>
      </div>
    </div>
    
    <!-- Ticker de actividades GRANDE -->
    <div class="activity-ticker" style="margin-bottom: 15px;">
      <div class="ticker-header" style="padding: 12px 16px; font-size: 14px; font-weight: bold;">üìà ACTIVIDAD EN TIEMPO REAL - CABA</div>
      <div id="ticker-content" class="ticker-content" style="padding: 12px 0; font-size: 15px;">
        <div class="ticker-item" style="padding: 0 32px;">üö® Sistema iniciando...</div>
      </div>
    </div>

    <!-- Mapa -->
    <div id="map" style="height: calc(100% - 150px); border-radius: 8px;"></div>
  </div>

  <!-- Panel lateral derecho con informaci√≥n -->
  <div style="display: flex; flex-direction: column; gap: 16px; max-height: calc(100vh - 120px); overflow-y: auto;">
    
    <!-- Leyenda -->
    <div class="card" style="padding: 15px;">
      <div style="background: rgba(59, 130, 246, 0.1); padding: 10px 12px; margin-bottom: 15px; border-radius: 8px; font-size: 14px; font-weight: bold; color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); text-align: center;">
        üó∫Ô∏è LEYENDA
      </div>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px;">
        <div class="legend-item">
          <span class="dot rojo"></span>
          <span>Cr√≠ticas</span>
        </div>
        <div class="legend-item">
          <span class="dot amarillo"></span>
          <span>Urgentes</span>
        </div>
        <div class="legend-item">
          <span class="dot verde"></span>
          <span>Leves</span>
        </div>
        <div class="legend-item">
          <span class="dot agente-policia"></span>
          <span>Polic√≠a</span>
        </div>
        <div class="legend-item">
          <span class="dot agente-bomberos"></span>
          <span>Bomberos</span>
        </div>
        <div class="legend-item">
          <span class="dot agente-same"></span>
          <span>SAME</span>
        </div>
        <div class="legend-item">
          <span class="dot agente-transito"></span>
          <span>Tr√°nsito</span>
        </div>
        <div class="legend-item">
          <span class="dot instalacion"></span>
          <span>Instalaciones</span>
        </div>
      </div>
    </div>

    <!-- Estad√≠sticas operativas -->
    <div class="card" style="padding: 15px;">
      <h3 style="margin: 0 0 15px 0; color: #60a5fa; font-size: 16px;">üìä Estado Operativo</h3>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
        <div class="stat-mini">
          <div class="value">{{ emergencies.count }}</div>
          <div>Emergencias Activas</div>
        </div>
        <div class="stat-mini">
          <div class="value">{{ agents.count }}</div>
          <div>Agentes en Campo</div>
        </div>
        <div class="stat-mini">
          <div class="value">{{ facilities.count }}</div>
          <div>Instalaciones</div>
        </div>
        <div class="stat-mini">
          <div class="value">15</div>
          <div>Comunas</div>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n de CABA -->
    <div class="card" style="padding: 15px;">
      <div style="background: linear-gradient(135deg, #1e40af, #3730a3); padding: 15px; border-radius: 12px; color: white; text-align: center;">
        <h4 style="margin: 0 0 8px 0; font-size: 16px;">üèõÔ∏è CIUDAD AUT√ìNOMA DE BUENOS AIRES</h4>
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 12px;">Sistema Unificado de Emergencias</div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px;">
          <div><strong>Superficie:</strong><br>200 km¬≤</div>
          <div><strong>Poblaci√≥n:</strong><br>3.1M hab.</div>
          <div><strong>Densidad:</strong><br>15,500 hab/km¬≤</div>
          <div><strong>Comunas:</strong><br>15 distritos</div>
        </div>
      </div>
    </div>

    <!-- √öltimas actividades -->
    <div class="card" style="padding: 15px;">
      <div class="emergency-ticker">
        <div class="ticker-title">üì¢ √öltimas Actividades del Sistema</div>
        <div style="margin-top: 10px; font-size: 12px; line-height: 1.4;">
          <div style="padding: 8px 0; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">üö® Nueva emergencia reportada en Comuna 1</div>
          <div style="padding: 8px 0; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">üöî Patrulla despachada a Balvanera</div>
          <div style="padding: 8px 0; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">üöë Ambulancia en ruta a hospital Fern√°ndez</div>
          <div style="padding: 8px 0; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">üöí Bomberos controlaron incendio en Palermo</div>
          <div style="padding: 8px 0;">‚úÖ Emergencia resuelta en San Telmo</div>
        </div>
      </div>
    </div>
  </div>
</div>

{% load l10n %}
<script>
  // Configuraci√≥n espec√≠fica de CABA
  const CABA_BOUNDS = {
    center: [-34.6118, -58.3960],  // Centro m√°s preciso de CABA
    bounds: [[-34.7347, -58.5314], [-34.5265, -58.3309]], // L√≠mites precisos de CABA
    zoom: 11  // Zoom m√°s alejado para ver toda CABA
  };

  // Coordenadas de las 15 comunas de CABA
  const COMUNAS_CABA = [
    {id: 1, name: "Comuna 1 - Retiro, San Nicol√°s, Puerto Madero, San Telmo, Montserrat, Constituci√≥n", center: [-34.6092, -58.3732]},
    {id: 2, name: "Comuna 2 - Recoleta", center: [-34.5938, -58.3963]},
    {id: 3, name: "Comuna 3 - Balvanera, San Crist√≥bal", center: [-34.6158, -58.4085]},
    {id: 4, name: "Comuna 4 - La Boca, Barracas, Parque Patricios, Nueva Pompeya", center: [-34.6346, -58.3635]},
    {id: 5, name: "Comuna 5 - Boedo, Almagro", center: [-34.6158, -58.4241]},
    {id: 6, name: "Comuna 6 - Caballito", center: [-34.6158, -58.4396]},
    {id: 7, name: "Comuna 7 - Flores, Parque Chacabuco", center: [-34.6304, -58.4634]},
    {id: 8, name: "Comuna 8 - Villa Soldati, Villa Riachuelo, Villa Lugano", center: [-34.6729, -58.4634]},
    {id: 9, name: "Comuna 9 - Liniers, Mataderos, Parque Avellaneda", center: [-34.6440, -58.5088]},
    {id: 10, name: "Comuna 10 - Villa Real, Monte Castro, Versalles, Floresta, V√©lez S√°rsfield, Villa Luro", center: [-34.6158, -58.4789]},
    {id: 11, name: "Comuna 11 - Villa General Mitre, Villa Devoto, Villa del Parque, Villa Santa Rita", center: [-34.6011, -58.4789]},
    {id: 12, name: "Comuna 12 - Coghlan, Saavedra, Villa Urquiza, Villa Pueyrred√≥n", center: [-34.5633, -58.4789]},
    {id: 13, name: "Comuna 13 - N√∫√±ez, Belgrano, Colegiales", center: [-34.5633, -58.4456]},
    {id: 14, name: "Comuna 14 - Palermo", center: [-34.5889, -58.4199]},
    {id: 15, name: "Comuna 15 - Chacarita, Villa Crespo, La Paternal, Villa Ort√∫zar, Agronom√≠a", center: [-34.5889, -58.4553]}
  ];

  // Inicializar mapa con vista de CABA
  var map = L.map('map', {
    center: CABA_BOUNDS.center,
    zoom: CABA_BOUNDS.zoom,
    maxBounds: CABA_BOUNDS.bounds,
    maxBoundsViscosity: 1.0
  });

  // Capa base mejorada
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
    maxZoom: 18,
    minZoom: 10
  }).addTo(map);

  // Grupos de capas para control de visibilidad
  const layerGroups = {
    emergencias: L.layerGroup().addTo(map),
    agentes: L.layerGroup().addTo(map),
    instalaciones: L.layerGroup().addTo(map),
    hospitales: L.layerGroup().addTo(map),
    comunas: L.layerGroup(),
    rutas: L.layerGroup().addTo(map)
  };

  // Variables para manejo de rutas
  let activeRoutes = [];
  let routePolygons = [];
  let selectedEmergency = null;
  let trackingInterval = null;

  // Funci√≥n para obtener colores por fuerza
  function getForceColor(force) {
    const colors = {
      'Polic√≠a': '#3b82f6',
      'Bomberos': '#dc2626', 
      'SAME': '#10b981',
      'Tr√°nsito': '#f59e0b'
    };
    return colors[force] || '#6b7280';
  }

  // Funci√≥n para obtener colores por tipo de emergencia
  function getEmergencyColor(code) {
    const colors = {
      'rojo': '#dc2626',
      'amarillo': '#f59e0b',
      'verde': '#22c55e'
    };
    return colors[code] || '#6b7280';
  }

  // Agregar marcadores de emergencias
  {% for emergency in emergencies %}
    {% if emergency.location_lat and emergency.location_lon %}
      var emergencyMarker = L.circleMarker([{{ emergency.location_lat|unlocalize }}, {{ emergency.location_lon|unlocalize }}], {
        radius: 8,
        color: getEmergencyColor('{{ emergency.code }}'),
        fillColor: getEmergencyColor('{{ emergency.code }}'),
        fillOpacity: 0.8,
        weight: 2,
        emergencyId: {{ emergency.id }}, // Agregar ID para identificaci√≥n
        emergency: {
          id: {{ emergency.id }},
          type: '{{ emergency.type|escapejs }}',
          code: '{{ emergency.code|escapejs }}',
          priority: '{{ emergency.priority|escapejs }}',
          lat: {{ emergency.location_lat|unlocalize }},
          lon: {{ emergency.location_lon|unlocalize }}
        }
      }).addTo(layerGroups.emergencias);
      
      var emergencyPopup = `
        <div style="min-width: 250px;">
          <h4 style="margin: 0 0 8px 0; color: ${getEmergencyColor('{{ emergency.code }}')};">
            üö® EMERGENCIA #{{ emergency.id }} {{ emergency.code|upper }}
          </h4>
          <p style="margin: 4px 0;"><strong>Descripci√≥n:</strong> {{ emergency.description|escapejs|truncatechars:80 }}</p>
          <p style="margin: 4px 0;"><strong>Direcci√≥n:</strong> {{ emergency.address|default:"Sin direcci√≥n"|escapejs }}</p>
          <p style="margin: 4px 0;"><strong>Estado:</strong> {{ emergency.status|title }}</p>
          <p style="margin: 4px 0;"><strong>Reportado:</strong> {{ emergency.reported_at|date:"d/m/Y H:i" }}</p>
          {% if emergency.assigned_force %}
            <p style="margin: 4px 0;"><strong>Fuerza:</strong> {{ emergency.assigned_force.name }}</p>
          {% endif %}
          {% if emergency.onda_verde %}
            <p style="color: #dc2626; font-weight: bold;">üö® ONDA VERDE ACTIVADA</p>
          {% endif %}
          <div style="margin-top: 12px; display: flex; gap: 5px; flex-wrap: wrap;">
            <button onclick="calculateRoutes({{ emergency.id }})" class="btn" style="background: #3b82f6; color: white; font-size: 11px; padding: 4px 8px;">
              üó∫Ô∏è Calcular Rutas
            </button>
            <button onclick="assignOptimalResources({{ emergency.id }})" class="btn" style="background: #10b981; color: white; font-size: 11px; padding: 4px 8px;">
              ‚ö° Asignar √ìptimo
            </button>
            {% if emergency.code == 'rojo' %}
            <button onclick="activateGreenWave({{ emergency.id }})" class="btn" style="background: #dc2626; color: white; font-size: 11px; padding: 4px 8px;">
              üö¶ Onda Verde
            </button>
            {% endif %}
            <a href="/detalle/{{ emergency.id }}/" class="btn" style="background: #6b7280; color: white; font-size: 11px; padding: 4px 8px; text-decoration: none;">
              üëÅÔ∏è Detalle
            </a>
          </div>
          <div id="routes-info-{{ emergency.id }}" style="margin-top: 10px; font-size: 12px; max-height: 150px; overflow-y: auto;"></div>
        </div>
      `;
      emergencyMarker.bindPopup(emergencyPopup);
      
      // Event listener para selecci√≥n de emergencia
      emergencyMarker.on('click', function() {
        selectedEmergency = {{ emergency.id }};
        highlightEmergency(emergencyMarker);
      });
    {% endif %}
  {% endfor %}

  // Agregar marcadores de instalaciones
  {% for f in facilities %}
    {% if f.lat and f.lon %}
      var facilityColor = '#8b5cf6';
      var facilityIcon = 'üè¢';
      {% if f.kind == 'cuartel' %}
        facilityColor = '#dc2626';
        facilityIcon = 'üöí';
      {% elif f.kind == 'comisaria' %}
        facilityColor = '#3b82f6';
        facilityIcon = 'üöî';
      {% elif f.kind == 'base_transito' %}
        facilityColor = '#f59e0b';
        facilityIcon = 'üö¶';
      {% endif %}
      
      var facilityMarker = L.circleMarker([{{ f.lat|unlocalize }}, {{ f.lon|unlocalize }}], {
        radius: 6,
        color: facilityColor,
        fillColor: facilityColor,
        fillOpacity: 0.9,
        weight: 2
      }).addTo(layerGroups.instalaciones);
      
      facilityMarker.bindPopup(`
        <div style="min-width: 180px;">
          <h4 style="margin: 0 0 8px 0; color: ${facilityColor};">
            ${facilityIcon} {{ f.get_kind_display }}
          </h4>
          <p style="margin: 4px 0;"><strong>{{ f.name|escapejs }}</strong></p>
          <p style="margin: 4px 0;">{{ f.address|default:""|escapejs }}</p>
          {% if f.force %}
            <p style="margin: 4px 0;"><strong>Fuerza:</strong> {{ f.force.name }}</p>
          {% endif %}
        </div>
      `);
    {% endif %}
  {% endfor %}

  // Agregar marcadores de hospitales con informaci√≥n de camas
  {% for h in hospitals %}
    {% if h.lat and h.lon %}
      var hospitalOccupancy = Math.round(({{ h.occupied_beds }} / {{ h.total_beds }}) * 100);
      var hospitalColor = hospitalOccupancy > 80 ? '#dc2626' : hospitalOccupancy > 60 ? '#f59e0b' : '#22c55e';
      
      var hospitalMarker = L.circleMarker([{{ h.lat|unlocalize }}, {{ h.lon|unlocalize }}], {
        radius: 8,
        color: hospitalColor,
        fillColor: hospitalColor,
        fillOpacity: 0.8,
        weight: 2
      }).addTo(layerGroups.hospitales);
      
      hospitalMarker.bindPopup(`
        <div style="min-width: 220px;">
          <h4 style="margin: 0 0 8px 0; color: ${hospitalColor};">
            üè• HOSPITAL
          </h4>
          <p style="margin: 4px 0;"><strong>{{ h.name|escapejs }}</strong></p>
          <p style="margin: 4px 0;">{{ h.address|escapejs }}</p>
          <div style="margin: 8px 0; padding: 6px; background: #f3f4f6; border-radius: 4px;">
            <p style="margin: 2px 0; font-size: 12px;">
              <strong>Capacidad:</strong> {{ h.total_beds }} camas
            </p>
            <p style="margin: 2px 0; font-size: 12px;">
              <strong>Ocupadas:</strong> {{ h.occupied_beds }} (${hospitalOccupancy}%)
            </p>
            <p style="margin: 2px 0; font-size: 12px;">
              <strong>Disponibles:</strong> {{ h.available_beds }}
            </p>
          </div>
        </div>
      `);
    {% endif %}
  {% endfor %}

  // Datos de agentes para animaci√≥n - LIMITADO para performance
  const agentMarkers = [];
  const agentData = [
    {% for a in agents|slice:":50" %}  {# Limitar a 50 agentes #}
      {% if a.lat and a.lon %}
      {
        id: {{ a.id }},
        name: "{{ a.name|escapejs }}",
        force: "{{ a.force.name|escapejs }}",
        role: "{{ a.role|default:''|escapejs }}",
        status: "{{ a.status|escapejs }}",
        lat: {{ a.lat|unlocalize }},
        lon: {{ a.lon|unlocalize }}
      },
      {% endif %}
    {% endfor %}
  ];

  // Funci√≥n para agregar/actualizar agentes
  function updateAgents() {
    if (agentMarkers.length === 0) {
      // Crear marcadores iniciales
      agentData.forEach(a => {
        const agentColor = getForceColor(a.force);
        const marker = L.circleMarker([a.lat, a.lon], {
          radius: 4,
          color: agentColor,
          fillColor: agentColor,
          fillOpacity: 0.9,
          weight: 1
        });
        
        marker.bindPopup(`
          <div style="min-width: 160px;">
            <h4 style="margin: 0 0 8px 0; color: ${agentColor};">
              üëÆ ${a.force}
            </h4>
            <p style="margin: 4px 0;"><strong>${a.name}</strong></p>
            <p style="margin: 4px 0;">${a.role}</p>
            <p style="margin: 4px 0;"><strong>Estado:</strong> ${a.status}</p>
          </div>
        `);
        
        marker.addTo(layerGroups.agentes);
        agentMarkers.push(marker);
      });
    } else {
      // Movimiento simulado dentro de CABA
      agentData.forEach((a, idx) => {
        const step = (Math.random() * 0.002 - 0.001); // ~100m steps
        const step2 = (Math.random() * 0.002 - 0.001);
        
        a.lat += step;
        a.lon += step2;
        
        // Mantener dentro de los l√≠mites de CABA
        if (a.lat < CABA_BOUNDS.bounds[0][0]) a.lat = CABA_BOUNDS.bounds[0][0] + Math.random() * 0.001;
        if (a.lat > CABA_BOUNDS.bounds[1][0]) a.lat = CABA_BOUNDS.bounds[1][0] - Math.random() * 0.001;
        if (a.lon < CABA_BOUNDS.bounds[0][1]) a.lon = CABA_BOUNDS.bounds[0][1] + Math.random() * 0.001;
        if (a.lon > CABA_BOUNDS.bounds[1][1]) a.lon = CABA_BOUNDS.bounds[1][1] - Math.random() * 0.001;
        
        agentMarkers[idx].setLatLng([a.lat, a.lon]);
      });
    }
  }

  // Agregar marcadores de comunas
  function addComunas() {
    COMUNAS_CABA.forEach(comuna => {
      const marker = L.circleMarker(comuna.center, {
        radius: 12,
        color: '#7c3aed',
        fillColor: '#7c3aed',
        fillOpacity: 0.3,
        weight: 2
      }).addTo(layerGroups.comunas);
      
      marker.bindPopup(`
        <div style="min-width: 200px;">
          <h4 style="margin: 0 0 8px 0; color: #7c3aed;">
            üìç ${comuna.name}
          </h4>
        </div>
      `);
    });
  }

  // Controles de capas
  document.querySelectorAll('.map-btn[data-layer]').forEach(btn => {
    btn.addEventListener('click', () => {
      const layer = btn.dataset.layer;
      
      if (layer === 'comunas') {
        if (map.hasLayer(layerGroups.comunas)) {
          map.removeLayer(layerGroups.comunas);
          btn.classList.remove('active');
        } else {
          addComunas();
          map.addLayer(layerGroups.comunas);
          btn.classList.add('active');
        }
        return;
      }
      
      if (map.hasLayer(layerGroups[layer])) {
        map.removeLayer(layerGroups[layer]);
        btn.classList.remove('active');
      } else {
        map.addLayer(layerGroups[layer]);
        btn.classList.add('active');
      }
    });
  });

  // Bot√≥n centrar
  document.getElementById('btn-centrar').addEventListener('click', () => {
    map.setView(CABA_BOUNDS.center, CABA_BOUNDS.zoom);
  });

  // Bot√≥n limpiar rutas
  document.getElementById('btn-limpiar-rutas').addEventListener('click', () => {
    clearRoutes();
    if (trackingInterval) {
      clearInterval(trackingInterval);
      trackingInterval = null;
    }
    
    // Limpiar informaci√≥n de rutas en todos los popups
    document.querySelectorAll('[id^="routes-info-"]').forEach(div => {
      div.innerHTML = '';
    });
    
    updateTickerWithActivity('üßπ Rutas limpiadas del mapa');
  });

  // Bot√≥n redistribuir agentes (con API inteligente)
  document.getElementById('btn-redistribuir').addEventListener('click', async () => {
    const button = document.getElementById('btn-redistribuir');
    button.innerHTML = '‚è≥';
    button.disabled = true;
    
    try {
      const response = await fetch('/api/redistribute/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        updateTickerWithActivity('üîÑ Recursos redistribuidos inteligentemente - Evitando r√≠o');
        // Recargar p√°gina para mostrar nueva distribuci√≥n
        setTimeout(() => {
          location.reload();
        }, 2000);
      } else {
        updateTickerWithActivity(`‚ùå Error redistribuyendo: ${data.message}`);
      }
    } catch (error) {
      updateTickerWithActivity(`‚ùå Error: ${error.message}`);
    } finally {
      button.innerHTML = 'üîÑ';
      button.disabled = false;
    }
  });

    // Test de rutas - DEBUG
    document.getElementById('btn-test-routes').addEventListener('click', function() {
      console.log('=== TEST DIRECTO DE API ===');
      
      // Test directo de API
      console.log('Probando API directamente...');
      
      fetch('/api/routes/30/')
        .then(response => {
          console.log('Test API Response Status:', response.status);
          console.log('Test API Response URL:', response.url);
          console.log('Test API Response OK:', response.ok);
          return response.text(); // Cambiar a text() para ver la respuesta cruda
        })
        .then(text => {
          console.log('Test API Raw Response:', text);
          try {
            const data = JSON.parse(text);
            console.log('Test API Parsed Data:', data);
            
            if (data.success && data.routes && data.routes.length > 0) {
              // Crear ruta de prueba directa
              const route = data.routes[0];
              const routeLine = L.polyline([
                [-34.6118, -58.4173], // Base
                [-34.6050, -58.4100]  // Destino
              ], {
                color: '#22c55e',
                weight: 8,
                opacity: 0.9
              }).addTo(layerGroups.rutas);
              
              routeLine.bindPopup(`
                <div>
                  <h6>‚úÖ RUTA DE PRUEBA EXITOSA</h6>
                  <p><strong>Distancia:</strong> ${route.distance} km</p>
                  <p><strong>Tiempo:</strong> ${route.duration} min</p>
                  <p><strong>Recurso:</strong> ${route.resource_type}</p>
                </div>
              `);
              
              console.log('‚úÖ Ruta de prueba mostrada en mapa');
              showNotification('‚úÖ API funciona! Ruta de prueba mostrada', 'success');
            } else {
              console.log('‚ùå API responde pero sin rutas v√°lidas');
              showNotification('‚ö†Ô∏è API responde pero sin rutas', 'warning');
            }
          } catch (e) {
            console.error('Error parsing JSON:', e);
            console.log('Respuesta no es JSON v√°lido:', text);
          }
        })
        .catch(error => {
          console.error('Error en API test:', error);
          showNotification('‚ùå Error de conexi√≥n con API', 'error');
        });
      
      // Tambi√©n probar emergencias encontradas
      console.log('=== EMERGENCIAS ENCONTRADAS ===');
      let emergencyCount = 0;
      layerGroups.emergencias.eachLayer(layer => {
        if (layer.options && layer.options.emergencyId) {
          emergencyCount++;
          console.log(`Emergencia ID: ${layer.options.emergencyId}`, layer.options.emergency);
        }
      });
      
      if (emergencyCount === 0) {
        showNotification('‚ÑπÔ∏è No se encontraron emergencias con coordenadas', 'info');
        console.log('No hay marcadores de emergencias con coordenadas');
      } else {
        console.log(`‚úÖ ${emergencyCount} emergencias encontradas`);
        showNotification(`üîç ${emergencyCount} emergencias encontradas. Ver consola.`, 'info');
      }
    });  // ===== FUNCIONES DE ONDA VERDE =====
  
  async function activateGreenWave(emergencyId) {
    const routesInfoDiv = document.getElementById(`routes-info-${emergencyId}`);
    routesInfoDiv.innerHTML = '<div style="color: #dc2626;">üö¶ Activando Onda Verde...</div>';
    
    try {
      const response = await fetch(`/api/green-wave/${emergencyId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      const data = await response.json();
      
      if (data.success) {
        routesInfoDiv.innerHTML = `
          <div style="border-top: 1px solid #dc2626; padding-top: 8px; margin-top: 8px;">
            <div style="color: #dc2626; font-weight: bold;">üö¶ ONDA VERDE ACTIVADA</div>
            <div style="font-size: 11px; margin: 4px 0;">
              ‚úÖ ${data.message}<br>
              üö¶ Intersecciones sincronizadas: ${data.total_intersections}<br>
              ‚è±Ô∏è Sem√°foros coordinados para paso libre
            </div>
          </div>
        `;
        
        // Iniciar visualizaci√≥n de sem√°foros
        startTrafficLightVisualization();
        
        updateTickerWithActivity(`üö¶ Onda Verde activada para Emergencia #${emergencyId} - ${data.total_intersections} sem√°foros`);
      } else {
        routesInfoDiv.innerHTML = `<div style="color: #dc2626;">‚ùå ${data.message}</div>`;
      }
      
    } catch (error) {
      console.error('Error activando onda verde:', error);
      routesInfoDiv.innerHTML = `<div style="color: #dc2626;">‚ùå Error: ${error.message}</div>`;
    }
  }
  
  async function startTrafficLightVisualization() {
    try {
      const response = await fetch('/api/traffic-status/');
      const data = await response.json();
      
      if (data.success && data.waves_data.length > 0) {
        // Limpiar visualizaciones anteriores de sem√°foros
        layerGroups.rutas.eachLayer(layer => {
          if (layer.options && layer.options.isTrafficLight) {
            layerGroups.rutas.removeLayer(layer);
          }
        });
        
        // Mostrar intersecciones con onda verde
        data.waves_data.forEach(wave => {
          wave.intersections.forEach(intersection => {
            const trafficIcon = L.circleMarker([intersection.lat, intersection.lon], {
              radius: 6,
              color: '#22c55e',
              fillColor: '#22c55e',
              fillOpacity: 0.8,
              weight: 2,
              className: 'traffic-light-green',
              isTrafficLight: true
            }).addTo(layerGroups.rutas);
            
            trafficIcon.bindPopup(`
              <div>
                <h5>üö¶ ${intersection.name}</h5>
                <p><strong>Estado:</strong> <span style="color: #22c55e;">VERDE - ONDA ACTIVA</span></p>
                <p><strong>Prioridad:</strong> ${intersection.priority === 1 ? 'Alta' : 'Normal'}</p>
                <p><strong>Verde hasta:</strong> ${new Date(intersection.green_end).toLocaleTimeString()}</p>
              </div>
            `);
          });
        });
      }
    } catch (error) {
      console.error('Error visualizando sem√°foros:', error);
    }
  }

  // Ticker de actividades
  function updateTicker() {
    const activities = [
      "üö® Nueva emergencia reportada en Comuna 1",
      "üöî Patrulla despachada a Balvanera", 
      "üöë Ambulancia en ruta a hospital Fern√°ndez",
      "üöí Bomberos controlaron incendio en Palermo",
      "üö¶ Tr√°nsito reporta congesti√≥n en 9 de Julio",
      "‚úÖ Emergencia resuelta en San Telmo"
    ];
    
    const ticker = document.getElementById('ticker-content');
    ticker.innerHTML = '';
    
    for (let i = 0; i < 3; i++) {
      const activity = activities[Math.floor(Math.random() * activities.length)];
      const div = document.createElement('div');
      div.className = 'ticker-item';
      div.textContent = activity;
      ticker.appendChild(div);
    }
  }

  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} notification-toast`;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    `;
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }

  // ===== FUNCIONES DE RUTEO AUTOM√ÅTICO =====
  
  function loadAutomaticRoutes() {
    // NO CARGAR RUTAS AUTOM√ÅTICAMENTE - Solo mostrar mensaje
    console.log('Sistema de rutas listo. Haz clic en "Calcular Rutas" para ver las rutas.');
    
    // Mostrar bot√≥n prominente para calcular rutas
    showRouteCalculationPrompt();
  }
  
  function showRouteCalculationPrompt() {
    const routePrompt = document.createElement('div');
    routePrompt.className = 'alert alert-info route-prompt';
    routePrompt.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
      animation: slideIn 0.5s ease-out;
    `;
    routePrompt.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>üö® Sistema de Rutas Listo</strong><br>
          <small>Haz clic para calcular rutas autom√°ticamente</small>
        </div>
        <div>
          <button onclick="calculateAllRoutes()" class="btn btn-primary btn-sm">
            üó∫Ô∏è Calcular Rutas
          </button>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn btn-close btn-sm ms-2"></button>
        </div>
      </div>
    `;
    
    document.body.appendChild(routePrompt);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
      if (routePrompt.parentElement) {
        routePrompt.remove();
      }
    }, 10000);
  }
  
  function calculateAllRoutes() {
    showNotification('üöÄ Iniciando c√°lculo de rutas...', 'info');
    
    // DEBUG: Verificar todas las capas
    console.log('=== DEBUG CAPAS ===');
    console.log('LayerGroups disponibles:', Object.keys(layerGroups));
    
    // Obtener todas las emergencias desde los marcadores de Leaflet
    const emergencyMarkers = [];
    let totalLayers = 0;
    
    layerGroups.emergencias.eachLayer(layer => {
      totalLayers++;
      console.log('Layer encontrado:', layer);
      
      if (layer.options && layer.options.emergencyId) {
        emergencyMarkers.push(layer);
        console.log('Emergencia v√°lida encontrada:', layer.options.emergencyId, layer.options.emergency);
      } else if (layer.getLatLng) {
        // Emergencia sin emergencyId - crear uno temporal
        const latlng = layer.getLatLng();
        layer.options = layer.options || {};
        layer.options.emergencyId = Math.floor(Math.random() * 1000) + Date.now();
        layer.options.emergency = {
          type: 'Emergencia Gen√©rica',
          priority: 'Normal'
        };
        emergencyMarkers.push(layer);
        console.log('Emergencia temporal creada:', layer.options.emergencyId);
      }
    });
    
    console.log(`Total layers: ${totalLayers}, Emergencias v√°lidas: ${emergencyMarkers.length}`);
    
    if (emergencyMarkers.length === 0) {
      showNotification('‚ÑπÔ∏è No hay emergencias activas con coordenadas. Creando rutas de prueba...', 'info');
      createTestRoutes();
      return;
    }
    
    let routesCalculated = 0;
    let totalEmergencies = emergencyMarkers.length;
    
    showNotification(`üìä Calculando rutas para ${totalEmergencies} emergencias...`, 'info');
    
    emergencyMarkers.forEach((marker, index) => {
      const emergencyId = marker.options.emergencyId;
      
      // Calcular con delay para no sobrecargar
      setTimeout(() => {
        console.log(`Calculando ruta para emergencia ${emergencyId}...`);
        
        fetch(`/api/routes/${emergencyId}/`)
        .then(response => {
          console.log(`Respuesta API emergencia ${emergencyId}:`, response.status);
          return response.json();
        })
        .then(data => {
          console.log(`Datos API emergencia ${emergencyId}:`, data);
          
          if (data.success && data.routes && data.routes.length > 0) {
            data.routes.forEach(route => {
              console.log('Mostrando ruta:', route);
              displayRouteOnMap({
                ...route,
                emergency_id: emergencyId,
                emergency_type: marker.options.emergency?.type || 'Emergencia',
                priority: marker.options.emergency?.priority || 'Normal'
              });
            });
            routesCalculated++;
            
            if (routesCalculated < totalEmergencies) {
              showNotification(`‚è≥ Calculadas ${routesCalculated}/${totalEmergencies} rutas...`, 'info');
            } else {
              showNotification(`‚úÖ Todas las rutas calculadas (${routesCalculated}/${totalEmergencies})`, 'success');
              activateTrafficLightsIfNeeded();
            }
          } else {
            console.log(`Sin rutas para emergencia ${emergencyId}:`, data);
            // Crear ruta de prueba si la API falla
            createFallbackRoute(marker, emergencyId);
            routesCalculated++;
            
            if (routesCalculated >= totalEmergencies) {
              showNotification(`‚úÖ Proceso completado. ${routesCalculated}/${totalEmergencies} emergencias procesadas`, 'success');
            }
          }
        })
        .catch(error => {
          console.error(`Error API emergencia ${emergencyId}:`, error);
          // Crear ruta de prueba en caso de error
          createFallbackRoute(marker, emergencyId);
          routesCalculated++;
          
          if (routesCalculated >= totalEmergencies) {
            showNotification(`‚ö†Ô∏è Proceso completado con algunos errores`, 'warning');
          }
        });
      }, index * 500); // 500ms delay entre cada c√°lculo
    });
    
    // Remover el prompt
    document.querySelector('.route-prompt')?.remove();
  }
  
  function createTestRoutes() {
    // Crear algunas rutas de prueba en CABA
    const testRoutes = [
      {
        name: 'Ruta Test 1 - Plaza de Mayo a Palermo',
        coordinates: [
          [-34.6118, -58.4173], // Plaza de Mayo
          [-34.5875, -58.4050]  // Palermo
        ],
        type: 'Emergencia Test',
        priority: 'Alto'
      },
      {
        name: 'Ruta Test 2 - Retiro a San Telmo',
        coordinates: [
          [-34.5989, -58.3734], // Retiro
          [-34.6214, -58.3731]  // San Telmo
        ],
        type: 'Emergencia Test',
        priority: 'Cr√≠tico'
      }
    ];
    
    testRoutes.forEach((testRoute, index) => {
      setTimeout(() => {
        const routeLine = L.polyline(testRoute.coordinates, {
          color: testRoute.priority === 'Cr√≠tico' ? '#ef4444' : '#f59e0b',
          weight: 6,
          opacity: 0.8,
          emergencyId: `test_${index}`,
          priority: testRoute.priority
        }).addTo(layerGroups.rutas);
        
        routeLine.bindPopup(`
          <div class="route-popup">
            <h6>üß™ ${testRoute.name}</h6>
            <p><strong>Tipo:</strong> ${testRoute.type}</p>
            <p><strong>Prioridad:</strong> ${testRoute.priority}</p>
            <p><strong>Estado:</strong> Ruta de prueba</p>
          </div>
        `);
        
        animateRoute(routeLine);
        
        if (index === testRoutes.length - 1) {
          showNotification('‚úÖ Rutas de prueba creadas exitosamente', 'success');
        }
      }, index * 1000);
    });
  }
  
  function createFallbackRoute(marker, emergencyId) {
    if (!marker.getLatLng) return;
    
    const emergencyPos = marker.getLatLng();
    const basePos = [-34.6118, -58.4173]; // Plaza de Mayo como base
    
    const routeLine = L.polyline([basePos, [emergencyPos.lat, emergencyPos.lng]], {
      color: '#3b82f6',
      weight: 4,
      opacity: 0.6,
      emergencyId: emergencyId,
      priority: 'Normal',
      dashArray: '10,10' // L√≠nea punteada para indicar que es fallback
    }).addTo(layerGroups.rutas);
    
    routeLine.bindPopup(`
      <div class="route-popup">
        <h6>üöó Ruta Directa</h6>
        <p><strong>Emergencia ID:</strong> ${emergencyId}</p>
        <p><strong>Tipo:</strong> Ruta de respaldo</p>
        <p><strong>Estado:</strong> L√≠nea directa estimada</p>
      </div>
    `);
    
    console.log(`Ruta fallback creada para emergencia ${emergencyId}`);
  }
  
  function activateTrafficLightsIfNeeded() {
    // Verificar si hay rutas de c√≥digo rojo y activar sem√°foros
    let hasRedCodeRoutes = false;
    layerGroups.rutas.eachLayer(layer => {
      if (layer.options && layer.options.priority === 'Cr√≠tico') {
        hasRedCodeRoutes = true;
      }
    });
    
    if (hasRedCodeRoutes) {
      showNotification('üö¶ Activando onda verde para emergencias cr√≠ticas...', 'info');
      activateTrafficLights();
    }
  }
  
  function displayRouteOnMap(route) {
    if (!route.geometry || !route.geometry.coordinates) {
      console.log('Ruta sin geometr√≠a v√°lida:', route);
      return;
    }
    
    // Convertir coordenadas de [lon, lat] a [lat, lon] para Leaflet
    const latLngs = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
    
    // Color seg√∫n prioridad
    const colors = {
      'Cr√≠tico': '#ef4444',
      'Alto': '#f59e0b', 
      'Normal': '#3b82f6'
    };
    
    const routeColor = colors[route.priority] || '#3b82f6';
    
    const routeLine = L.polyline(latLngs, {
      color: routeColor,
      weight: 6,
      opacity: 0.8,
      emergencyId: route.emergency_id,
      priority: route.priority // Guardar prioridad para referencia
    }).addTo(layerGroups.rutas);
    
    // Agregar popup con informaci√≥n de la ruta
    routeLine.bindPopup(`
      <div class="route-popup">
        <h6>üö® ${route.emergency_type || 'Emergencia'}</h6>
        <p><strong>Prioridad:</strong> <span style="color: ${routeColor};">${route.priority || 'Normal'}</span></p>
        <p><strong>Distancia:</strong> ${route.distance || 'N/A'} km</p>
        <p><strong>Tiempo estimado:</strong> ${route.duration || 'N/A'} min</p>
        <p><strong>Recurso:</strong> ${route.resource_type || 'No asignado'}</p>
        <hr>
        <button onclick="recalculateRoute(${route.emergency_id})" class="btn btn-sm btn-primary">
          üîÑ Recalcular
        </button>
        <button onclick="viewRouteDetails(${route.emergency_id})" class="btn btn-sm btn-info">
          üìä Ver detalles
        </button>
      </div>
    `);
    
    // Animar la l√≠nea
    animateRoute(routeLine);
    
    console.log(`Ruta mostrada para emergencia ${route.emergency_id}:`, route);
  }
  
  function animateRoute(routeLine) {
    let dashOffset = 0;
    routeLine.setStyle({
      dashArray: '20, 10',
      dashOffset: dashOffset
    });
    
    const animate = () => {
      dashOffset -= 2;
      routeLine.setStyle({dashOffset: dashOffset});
      if (Math.abs(dashOffset) < 100) {
        requestAnimationFrame(animate);
      }
    };
    animate();
  }
  
  function recalculateRoute(emergencyId) {
    fetch(`/calculate-routes/${emergencyId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Limpiar rutas existentes para esta emergencia
        layerGroups.rutas.eachLayer(layer => {
          if (layer.options && layer.options.emergencyId === emergencyId) {
            layerGroups.rutas.removeLayer(layer);
          }
        });
        
        // Mostrar nuevas rutas
        data.routes.forEach(route => {
          displayRouteOnMap(route);
        });
        
        showNotification('‚úÖ Ruta recalculada exitosamente', 'success');
      } else {
        showNotification('‚ùå Error al recalcular ruta', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('‚ùå Error de conexi√≥n', 'error');
    });
  }
  
  function viewRouteDetails(emergencyId) {
    fetch(`/route-details/${emergencyId}/`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showRouteDetailsModal(data.route_details);
      }
    })
    .catch(error => console.error('Error:', error));
  }
  
  function showRouteDetailsModal(details) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">üìä Detalles de la Ruta</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <h6>üö® Informaci√≥n de la Emergencia</h6>
                <p><strong>Tipo:</strong> ${details.emergency_type}</p>
                <p><strong>Prioridad:</strong> ${details.priority}</p>
                <p><strong>Ubicaci√≥n:</strong> ${details.address}</p>
              </div>
              <div class="col-md-6">
                <h6>üöó Informaci√≥n del Recurso</h6>
                <p><strong>Tipo:</strong> ${details.resource_type}</p>
                <p><strong>Identificaci√≥n:</strong> ${details.resource_id}</p>
                <p><strong>Ubicaci√≥n actual:</strong> ${details.current_location}</p>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-md-4">
                <div class="text-center">
                  <h6>üìè Distancia</h6>
                  <span class="badge bg-primary fs-6">${details.distance} km</span>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <h6>‚è±Ô∏è Tiempo Estimado</h6>
                  <span class="badge bg-warning fs-6">${details.duration} min</span>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <h6>üö¶ Sem√°foros</h6>
                  <span class="badge bg-success fs-6">${details.traffic_lights_count}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    modal.addEventListener('hidden.bs.modal', () => {
      document.body.removeChild(modal);
    });
  }
  
  function showRouteInfo(route) {
    const infoPanel = document.getElementById('info-panel');
    if (infoPanel) {
      const routeCard = document.createElement('div');
      routeCard.className = 'alert alert-info mb-2';
      routeCard.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>üö® ${route.emergency_type}</strong><br>
            <small>üìè ${route.distance}km | ‚è±Ô∏è ${route.duration}min</small>
          </div>
          <div>
            <button onclick="recalculateRoute(${route.emergency_id})" class="btn btn-sm btn-outline-primary">
              üîÑ
            </button>
          </div>
        </div>
      `;
      infoPanel.appendChild(routeCard);
    }
  }

  // ===== FUNCIONES DE RUTEO =====
  
  function highlightEmergency(marker) {
    // Resaltar emergencia seleccionada
    marker.setStyle({
      radius: 12,
      weight: 5,
      className: 'emergency-selected'
    });
  }
  
  function clearRoutes() {
    // Limpiar rutas anteriores
    layerGroups.rutas.clearLayers();
    activeRoutes = [];
    routePolygons = [];
  }
  
  async function calculateRoutes(emergencyId) {
    const routesInfoDiv = document.getElementById(`routes-info-${emergencyId}`);
    routesInfoDiv.innerHTML = '<div style="color: #3b82f6;">üîÑ Calculando rutas optimizadas...</div>';
    
    try {
      const response = await fetch(`/api/routes/${emergencyId}/`);
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Error calculando rutas');
      }
      
      // Verificar si la emergencia est√° resuelta
      if (data.emergency && data.emergency.status === 'resuelta') {
        routesInfoDiv.innerHTML = `
          <div style="background: #d4edda; padding: 10px; border-radius: 4px; border-left: 4px solid #28a745;">
            <strong style="color: #155724;">‚úÖ EMERGENCIA RESUELTA</strong>
            <p style="margin: 5px 0 0 0; color: #155724; font-size: 12px;">
              Las rutas se han completado. <a href="/detalle/${emergencyId}/" style="color: #0d6efd;">Ver detalle</a>
            </p>
          </div>
        `;
        return; // No mostrar rutas en el mapa
      }
      
      clearRoutes(); // Limpiar rutas anteriores
      
      if (data.routes.length === 0) {
        routesInfoDiv.innerHTML = '<div style="color: #f59e0b;">‚ö†Ô∏è No hay recursos disponibles</div>';
        return;
      }
      
      // Mostrar informaci√≥n de rutas
      let routesHtml = '<div style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px;">';
      routesHtml += `<strong>ÔøΩ Recursos Asignados (${data.routes.length}):</strong><br>`;
      
      data.routes.forEach((route, index) => {
        console.log('Procesando ruta:', route); // Debug
        
        // Dibujar ruta en el mapa
        if (route.geometry && route.geometry.coordinates && route.geometry.coordinates.length > 0) {
          try {
            const routeColor = getRouteColor(index);
            const routeLine = L.geoJSON(route.geometry, {
              style: {
                color: routeColor,
                weight: 5,
                opacity: 0.9,
                dashArray: index === 0 ? '0' : '10,5'  // Primera ruta s√≥lida, otras punteadas
              }
            }).addTo(layerGroups.rutas);
            
            // A√±adir popup a la ruta
            routeLine.bindPopup(`
              <div>
                <h5>${route.resource_type || 'Recurso desconocido'}</h5>
                <p><strong>üìè Distancia:</strong> ${route.distance} km</p>
                <p><strong>‚è±Ô∏è ETA:</strong> ${route.duration} min</p>
                <p><strong>üèÜ Prioridad:</strong> ${index + 1}¬∞</p>
              </div>
            `);
            
            activeRoutes.push({
              id: route.resource_id,
              line: routeLine,
              route: route
            });
            
            console.log('‚úì Ruta dibujada exitosamente'); // Debug
          } catch (err) {
            console.error('Error dibujando ruta:', err);
          }
        } else {
          console.log('Ruta sin geometr√≠a v√°lida:', route); // Debug
        }
        
        // A√±adir informaci√≥n al popup con mejor explicaci√≥n
        let priority, priorityColor, explanation;
        
        if (index === 0) {
            priority = 'üö® RUTA √ìPTIMA';
            priorityColor = '#ff4444';
            explanation = '‚≠ê Menor tiempo + distancia';
        } else if (index === 1) {
            priority = '‚ö° RUTA R√ÅPIDA';  
            priorityColor = '#ff8800';
            explanation = 'üîÑ Segunda mejor opci√≥n';
        } else {
            priority = `üõ°Ô∏è BACKUP ${index + 1}`;
            priorityColor = '#4CAF50';
            explanation = 'üîß Recurso de respaldo';
        }
        
        const resourceIcon = route.resource_type.includes('Ambulancia') ? 'üöë' : 
                           route.resource_type.includes('Bombero') ? 'üöí' :
                           route.resource_type.includes('Polic√≠a') ? 'üöî' : 'üö®';
        
        routesHtml += `
          <div style="font-size: 12px; margin: 6px 0; padding: 8px; border-left: 4px solid ${priorityColor}; background: rgba(255,255,255,0.9); border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-weight: bold; color: ${priorityColor}; margin-bottom: 4px;">${priority}</div>
            <div style="margin-bottom: 4px;">${resourceIcon} <strong>${route.resource_type || 'Recurso'}</strong></div>
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666;">
              <span>üìè ${route.distance} km</span>
              <span>‚è±Ô∏è ${route.duration} min</span>
              <span>üìä Score: ${route.score}</span>
            </div>
            <div style="font-size: 10px; color: #888; margin-top: 4px; font-style: italic;">
              ${explanation}
            </div>
          </div>
        `;
      });
      
      routesHtml += '</div>';
      routesInfoDiv.innerHTML = routesHtml;
      
      // Centrar mapa en las rutas si existen
      if (activeRoutes.length > 0) {
        try {
          const group = new L.featureGroup(activeRoutes.map(r => r.line));
          map.fitBounds(group.getBounds(), { padding: [20, 20] });
        } catch (err) {
          console.error('Error centrando mapa:', err);
        }
      }
      
    } catch (error) {
      console.error('Error calculando rutas:', error);
      routesInfoDiv.innerHTML = `<div style="color: #dc2626;">‚ùå Error: ${error.message}</div>`;
    }
  }
  
  async function assignOptimalResources(emergencyId) {
    const routesInfoDiv = document.getElementById(`routes-info-${emergencyId}`);
    routesInfoDiv.innerHTML = '<div style="color: #10b981;">üöÄ Asignando recursos √≥ptimos...</div>';
    
    try {
      const response = await fetch(`/api/assign/${emergencyId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Error asignando recursos');
      }
      
      // Mostrar resultado de asignaci√≥n
      let assignedHtml = '<div style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px;">';
      assignedHtml += `<div style="color: #10b981; font-weight: bold;">‚úÖ ${data.message}</div>`;
      
      data.assigned.forEach(resource => {
        assignedHtml += `
          <div style="font-size: 11px; margin: 4px 0; color: #059669;">
            üö® ${resource.resource_name}<br>
            &nbsp;&nbsp;&nbsp;üìè ${resource.distance_km} km | ‚è±Ô∏è ${resource.eta_minutes} min
          </div>
        `;
      });
      
      assignedHtml += '</div>';
      routesInfoDiv.innerHTML = assignedHtml;
      
      // Iniciar seguimiento en tiempo real
      startRealTimeTracking();
      
      // Actualizar ticker con nueva actividad
      updateTickerWithActivity(`üö® Recursos asignados a Emergencia #${emergencyId}`);
      
    } catch (error) {
      console.error('Error asignando recursos:', error);
      routesInfoDiv.innerHTML = `<div style="color: #dc2626;">‚ùå Error: ${error.message}</div>`;
    }
  }
  
  function getRouteColor(index) {
    const colors = ['#dc2626', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
    return colors[index % colors.length];
  }
  
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  async function startRealTimeTracking() {
    if (trackingInterval) clearInterval(trackingInterval);
    
    trackingInterval = setInterval(async () => {
      try {
        const response = await fetch('/api/tracking/');
        const data = await response.json();
        
        if (data.tracking_data.length > 0) {
          updateTrackingVisualization(data.tracking_data);
          updateTickerWithTracking(data.tracking_data);
        }
      } catch (error) {
        console.error('Error en seguimiento:', error);
      }
    }, 10000); // Cada 10 segundos
  }
  
  function updateTrackingVisualization(trackingData) {
    // Limpiar visualizaciones anteriores de seguimiento
    layerGroups.rutas.eachLayer(layer => {
      if (layer.options && layer.options.isTracking) {
        layerGroups.rutas.removeLayer(layer);
      }
    });
    
    // Mostrar recursos en ruta
    trackingData.forEach(resource => {
      if (resource.route_geometry && resource.route_geometry.coordinates) {
        const trackingLine = L.geoJSON(resource.route_geometry, {
          style: {
            color: '#10b981',
            weight: 6,
            opacity: 0.9,
            dashArray: '5,15'
          },
          isTracking: true
        }).addTo(layerGroups.rutas);
        
        trackingLine.bindPopup(`
          <div>
            <h5>üö® ${resource.name} - EN RUTA</h5>
            <p><strong>ETA Restante:</strong> ${resource.eta_minutes} min</p>
            <p><strong>Distancia:</strong> ${resource.distance_remaining_km} km</p>
            <p><strong>Estado:</strong> ${resource.status}</p>
          </div>
        `);
      }
    });
  }
  
  function updateTickerWithActivity(message) {
    const ticker = document.getElementById('ticker-content');
    const newActivity = document.createElement('div');
    newActivity.className = 'ticker-item';
    newActivity.textContent = message;
    newActivity.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
    newActivity.style.border = '1px solid rgba(16, 185, 129, 0.3)';
    ticker.insertBefore(newActivity, ticker.firstChild);
    
    // Mantener solo las √∫ltimas 3 actividades
    while (ticker.children.length > 3) {
      ticker.removeChild(ticker.lastChild);
    }
  }
  
  function updateTickerWithTracking(trackingData) {
    if (trackingData.length === 0) return;
    
    const messages = [
      `üöî ${trackingData.length} recursos en ruta hacia emergencias`,
      `‚è±Ô∏è Pr√≥ximo arribo en ${Math.min(...trackingData.map(r => r.eta_minutes))} minutos`,
      `üìä Seguimiento activo de recursos despachados`
    ];
    
    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
    updateTickerWithActivity(randomMessage);
  }

  // Inicializaci√≥n con indicador de carga
  document.addEventListener('DOMContentLoaded', function() {
    showLoadingIndicator();
    
    // Cargar componentes progresivamente
    setTimeout(() => {
      updateAgents();
      hideLoadingIndicator();
    }, 500);
    
    setTimeout(() => {
      updateTicker();
    }, 1000);
    
    setTimeout(() => {
      loadAutomaticRoutes(); // Preparar sistema de rutas
    }, 1500);
  });
  
  function showLoadingIndicator() {
    const loader = document.createElement('div');
    loader.id = 'page-loader';
    loader.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    `;
    loader.innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-light mb-3" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <div>üö® Cargando Sistema de Emergencias...</div>
        <div class="mt-2"><small>Optimizando datos para mejor rendimiento</small></div>
      </div>
    `;
    document.body.appendChild(loader);
  }
  
  function hideLoadingIndicator() {
    const loader = document.getElementById('page-loader');
    if (loader) {
      loader.style.opacity = '0';
      setTimeout(() => loader.remove(), 500);
    }
  }
  
  // Actualizaciones peri√≥dicas - REDUCIR FRECUENCIA
  setInterval(updateAgents, 15000); // Mover agentes cada 15s (era 5s)
  setInterval(updateTicker, 20000); // Actualizar ticker cada 20s (era 10s)
</script>
{% endblock %}
