{% extends 'core/base.html' %}
{% block title %}Detalle de Emergencia{% endblock %}
{% block extra_styles %}
.tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; color: #fff; }
.tag.rojo { background: #d9534f; }
.tag.amarillo { background: #f0ad4e; }
.tag.verde { background: #22c55e; }
pre { background: #0b1220; padding: 10px; border-radius: 6px; white-space: pre-wrap; border:1px solid #1f2937; }
{% endblock %}
{% block content %}
    <h1>Emergencia #{{ emergency.id }} <span class="tag {{ emergency.code }}">{{ emergency.code|upper }}</span></h1>
    <p><strong>Descripci√≥n:</strong> {{ emergency.description }}</p>
    <p><strong>Direcci√≥n:</strong> {{ emergency.address }}</p>
    <p><strong>Estado:</strong> {{ emergency.status }} {% if emergency.onda_verde %} | <strong>Onda Verde:</strong> ACTIVADA{% endif %}</p>
    {% if emergency.assigned_force %}
        <p><strong>Fuerza:</strong> {{ emergency.assigned_force.name }} {% if emergency.assigned_vehicle %} | <strong>Veh√≠culo:</strong> {{ emergency.assigned_vehicle.type }}{% endif %}</p>
    {% endif %}

    <h3>Informe de Proceso</h3>
    {% if emergency.ai_response %}
        <div style="background: linear-gradient(135deg, #1e40af, #3730a3); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #60a5fa;">
            <h4 style="margin: 0 0 8px 0; color: #93c5fd; font-size: 14px;">ü§ñ AN√ÅLISIS DE IA</h4>
            <p style="margin: 0; color: #e2e8f0; line-height: 1.4;">{{ emergency.ai_response }}</p>
        </div>
    {% endif %}
    <pre>{{ emergency.resolution_notes }}</pre>

    {% if emergency.dispatches.all %}
    <h3>Despachos</h3>
    <ul>
        {% for d in emergency.dispatches.all %}
            <li>{{ d.force.name }} {% if d.vehicle %}- Veh√≠culo: {{ d.vehicle.type }}{% endif %} - Estado: {{ d.status }} - {{ d.created_at|date:"d/m/Y H:i" }}</li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if calculated_routes %}
    <h3>üöó Rutas Calculadas</h3>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">
        <p style="margin: 0 0 10px 0; color: #6c757d; font-size: 14px;">
            Las siguientes rutas fueron calculadas autom√°ticamente para esta emergencia:
        </p>
        
        {% for route in calculated_routes %}
        <div style="background: white; margin: 10px 0; padding: 12px; border-radius: 6px; border-left: 3px solid 
            {% if forloop.counter == 1 %}#dc3545{% elif forloop.counter == 2 %}#fd7e14{% else %}#28a745{% endif %};">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-weight: bold; color: #495057;">
                    {% if forloop.counter == 1 %}üö® RUTA √ìPTIMA{% elif forloop.counter == 2 %}‚ö° RUTA R√ÅPIDA{% else %}üõ°Ô∏è BACKUP {{ forloop.counter }}{% endif %}
                    - {{ route.resource_type }}
                </div>
                <span class="tag {% if route.status == 'activa' %}verde{% elif route.status == 'completada' %}amarillo{% else %}rojo{% endif %}">
                    {{ route.status|upper }}
                </span>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 13px; color: #6c757d;">
                <div><strong>üìè Distancia:</strong> {{ route.distance_km|floatformat:1 }} km</div>
                <div><strong>‚è±Ô∏è Tiempo:</strong> {{ route.estimated_time_minutes|floatformat:1 }} min</div>
                <div><strong>üìä Score:</strong> {{ route.priority_score|floatformat:1 }}</div>
                <div><strong>üìÖ Calculado:</strong> {{ route.calculated_at|date:"d/m H:i" }}</div>
            </div>
            
            {% if route.completed_at %}
            <div style="margin-top: 8px; padding: 6px; background: #d4edda; border-radius: 4px; font-size: 12px; color: #155724;">
                ‚úÖ Completado: {{ route.completed_at|date:"d/m/Y H:i" }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        
        {% if emergency.status == 'resuelta' %}
        <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 4px; border-left: 4px solid #28a745;">
            <strong style="color: #155724;">‚úÖ EMERGENCIA RESUELTA</strong>
            <p style="margin: 5px 0 0 0; color: #155724; font-size: 14px;">
                Las rutas se han marcado autom√°ticamente como completadas.
            </p>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 15px 0;">
        <h3 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Sin Rutas Calculadas</h3>
        <p style="margin: 0; color: #856404; font-size: 14px;">
            No se han calculado rutas para esta emergencia a√∫n. 
            <a href="/" style="color: #007bff; text-decoration: underline;">Ir al mapa para calcular rutas</a>
        </p>
    </div>
    {% endif %}

    <div class="actions">
        <a class="btn" href="{% url 'emergency_list' %}">Volver a la Lista</a>
        {% if emergency.status != 'resuelta' %}
        <form method="post" action="{% url 'resolve_emergency' emergency.id %}" style="display:inline;">
            {% csrf_token %}
            <input type="text" name="notas" placeholder="Notas de resoluci√≥n (opcional)" style="width: 400px;">
            <button class="btn" type="submit">Marcar como Resuelta</button>
        </form>
        {% endif %}
    </div>
{% endblock %}
